[BITS 16]
[ORG 0x1000]

MOV SI, Hello
CALL PrintString
JMP EnterPM
CLI
JMP $

PrintChar:
MOV AH, 0x0E
MOV BH, 0x00
MOV BL, 0x0F
INT 0x10

PrintString:
MOV AL, [SI]
INC SI
OR AL, AL
JZ Exit
CALL PrintChar
JMP PrintString
Exit:
RET

PMMessage DB 'Attempting Switch To Protected Mode',0x0D,0
Hello DB 'Second Stage Success...',0x0D,0

EnterPM:
MOV SI, PMMessage
CALL PrintString

MOV AX, 0x2401
XOR AH, AH
INT 0x15
JC EnterPM

CLI
LGDT [GDT_POINTER]
MOV EAX, CR0
OR EAX, CR0
MOV CR0, EAX
STI

GDT_START:
	DQ 0x0
GDT_CODE:
	DW 0xFFFF
	DW 0x0
	DB 0x0
	DB 10011010b
	DB 11001111b
	DB 0x0
GDT_DATA:
	DW 0xFFFF
	DW 0x0
	DB 0x0
	DB 10010010b
	DB 11001111b
	DB 0x0
GDT_END:

GDT_POINTER:
	DW GDT_END - GDT_START
	DD GDT_START
CODE_SEG equ GDT_CODE - GDT_START
DATA_SEG equ GDT_DATA - GDT_START


TIMES 512-($-$$) DB 0